<section id="print" class="row">
  <div class="col-xl-12">
    <button type="button" class="float-right btn btn-outline-primary doNotPrint" (click)="onPrint();"><i class="fa fa-file-pdf-o"></i> Generar Esborrany </button>
  </div>
</section>
<div id="waterMark" style="display: none">
</div>
<section *ngIf="value">
  <div class="row m-3" >
    <ng-container>
      <div class="col-xl-12">
        <div class="card ">
          <div class="card-header text-white font-weight-bold bg-grey-400">
            RESUM VALORACIÓ
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-xl-12">
                <table class="table table-bordered">
                  <thead class="table-active bg-info">
                  <tr>
                    <ng-template ngFor [ngForOf]="value.valoracio?.evaluacions" let-evaluacio>
                      <ng-template [ngIf]="evaluacio?.ambit?.ambit?.descripcio.toUpperCase() === 'GLOBALITAT DEL CAS' ">
                        <th colspan="2" class="text-white border_top bg-grey-400">Valoració de risc del cas</th>
                      </ng-template>
                    </ng-template>
                  </tr>
                  </thead>
                  <tbody >
                  <ng-container>
                    <tr>
                      <ng-template ngFor [ngForOf]="value.valoracio?.evaluacions" let-evaluacio>
                        <ng-template [ngIf]="evaluacio?.ambit?.ambit?.descripcio.toUpperCase() === 'GLOBALITAT DEL CAS' ">
                          <th class="border_bot "
                            [ngClass]="{'warning' : evaluacio.risc?.descripcio.toUpperCase() === 'RISC',
                                      'danger' : evaluacio.risc?.descripcio.toUpperCase() === 'ALT RISC',
                                      'success' : evaluacio.risc?.descripcio.toUpperCase() === 'VULNERABILITAT',
                                      'info' : evaluacio.risc?.descripcio.toUpperCase() === 'SENSE VALORACI&#211;' }">
                            {{evaluacio?.risc?.descripcio}}
                          </th>
                        </ng-template>
                      </ng-template>
                    </tr>
                  </ng-container>
                  </tbody>
                </table>
              </div>
              <div class="col-xl-12">
                <table class="table table-bordered">
                  <tbody>
                  <ng-template ngFor [ngForOf]="value.valoracio?.evaluacions" let-evaluacio let-v="index">
                    <ng-template [ngIf]="evaluacio && evaluacio?.ambit?.ambit?.descripcio.toUpperCase() !== 'GLOBALITAT DEL CAS'">
                      <tr>
                        <th class="bg-primary bg-primary-exact text-white"    *ngIf="v===0 && evaluacio?.ambit?.ambit?.descripcio.toUpperCase() === 'AUTONOMIA'"> Autonomia Funcional </th>
                        <th class="bg-primary-80 text-white" *ngIf="v===1 && evaluacio?.ambit?.ambit?.descripcio.toUpperCase() === 'MATERIAL I INSTRUMENTAL'">Material i instrumental</th>
                        <th class="bg-primary-60 text-white" *ngIf="v===2&& evaluacio?.ambit?.ambit?.descripcio.toUpperCase() === 'RELACIONAL'"> Relacional</th>
                        <th class="bg-primary-40 text-white" *ngIf="v===3"> Risc {{evaluacio?.ambit?.ambit?.descripcio.toLocaleLowerCase()}}</th>

                        <th class="text-center" [ngClass]="{'warning amarillo' : evaluacio?.risc?.descripcio.toUpperCase() === 'RISC',
                                            'danger rojo' : evaluacio?.risc?.descripcio.toUpperCase() === 'ALT RISC',
                                            'success verde' : evaluacio?.risc?.descripcio.toUpperCase() === 'VULNERABILITAT',
                                            'info azul' : evaluacio?.risc?.descripcio.toUpperCase() === 'SENSE VALORACI&#211;'}">
                          {{evaluacio?.risc.descripcio}}</th>
                      </tr>
                    </ng-template>
                  </ng-template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
  <form #formTab="ngForm" ngNativeValidate (submit)="open(validation)">
  <!-- Ambito -->
  <div class="row m-3" *ngFor="let ambit of value.ambit;let i = index">
    <ng-container *ngIf="ambit?.ambit?.descripcio?.toUpperCase() !== 'GLOBALITAT DEL CAS'">
      <div class="col-xl-12">
        <div class="card">
          <div class="card-header text-white font-weight-bold"
               [ngClass]="{'rojo_1' : ambit?.ambit?.descripcio?.toUpperCase() === 'AUTONOMIA',
                         'rojo_2' : ambit.ambit?.descripcio.toUpperCase() === 'MATERIAL I INSTRUMENTAL',
                         'rojo_3' : ambit.ambit?.descripcio.toUpperCase() === 'RELACIONAL',
                         'rojo_4' : ambit.ambit?.descripcio.toUpperCase() === 'GLOBALITAT DEL CAS'}">
            {{ ambit.ambit?.descripcio?.toUpperCase() }}
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-xl-6">
                <table class="table table-bordered">
                  <thead class="table-active">
                  <th class="bg-primary-exact">{{ "OBS.ssocial" | translate }}</th>
                  <th class="text-center bg-primary-exact">{{ "OBS.person" | translate }}</th>
                  <th class="text-center bg-primary-exact ">{{ "OBS.risc" | translate }}</th>
                  </thead>
                  <tbody *ngFor="let entorn of ambit.entorn">
                  <ng-container *ngIf="entorn.pregunta.length > 0">
                    <tr *ngFor="let pregunta of entorn.pregunta">
                      <td [ngClass]="{'warning amarillo' : pregunta.factor?.descripcio.toUpperCase() === 'RISC',
                                      'danger rojo' : pregunta.factor?.descripcio.toUpperCase() === 'ALT RISC',
                                      'success verde' : pregunta.factor?.descripcio.toUpperCase() === 'VULNERABILITAT',
                                      'info azul' : pregunta.factor?.descripcio.toUpperCase() === 'SENSE VALORACI&#211;' }">{{ pregunta.situacioSocial.social }}</td>
                      <td class="text-center"
                          [ngClass]="{'warning amarillo' : pregunta.factor?.descripcio.toUpperCase() === 'RISC',
                                      'danger rojo' : pregunta.factor?.descripcio.toUpperCase() === 'ALT RISC',
                                      'success verde' : pregunta.factor?.descripcio.toUpperCase() === 'VULNERABILITAT',
                                      'info azul' : pregunta.factor?.descripcio.toUpperCase() === 'SENSE VALORACI&#211;' }" *ngIf="pregunta.persona">{{ pregunta.persona?.tipusPersona?.descripcio }}</td>
                      <td class="text-center"
                          [ngClass]="{'warning amarillo' : pregunta.factor?.descripcio.toUpperCase() === 'RISC',
                                      'danger rojo' : pregunta.factor?.descripcio.toUpperCase() === 'ALT RISC',
                                      'success verde' : pregunta.factor?.descripcio.toUpperCase() === 'VULNERABILITAT',
                                      'info azul' : pregunta.factor?.descripcio.toUpperCase() === 'SENSE VALORACI&#211;' }"*ngIf="!pregunta.persona">Unitat de Convivencia</td>
                      <td class="text-center"
                          [ngClass]="{'warning amarillo' : pregunta.factor?.descripcio.toUpperCase() === 'RISC',
                                      'danger rojo' : pregunta.factor?.descripcio.toUpperCase() === 'ALT RISC',
                                      'success verde' : pregunta.factor?.descripcio.toUpperCase() === 'VULNERABILITAT',
                                      'info azul' : pregunta.factor?.descripcio.toUpperCase() === 'SENSE VALORACI&#211;' }">
                        {{ pregunta.factor.descripcio }}</td>
                    </tr>
                  </ng-container>
                  <ng-container *ngIf="entorn.pregunta?.length == 0">
                    <!-- No hay Situación social -->
                    <tr class="text-center">
                      <td colspan="3" style="color: darkgreen"> Sense Risc en {{ entorn.descripcio }} </td>
                    </tr>
                    <!--/ No hay Situación social -->
                  </ng-container>
                  </tbody>
                </table>
                 <!--Result Automatic Evaluations -->
                <table class="table table-borderless" *ngFor="let evaluacion of value.valoracio?.evaluacions; let e = index;">
                  <ng-container *ngIf="evaluacion && evaluacion.ambit.ambit.id === ambit.ambit.id">
                    <tbody>
                    <!--Result Automatic Evaluations -->
                    <tr class="mr-3">
                      <td class="text-right">{{ "OBS.risc-auto" | translate }}</td>
                      <td class="text-center" [ngClass]="{'warning amarillo' : evaluacion.risc?.descripcio.toUpperCase() === 'RISC',
                                                            'danger rojo' : evaluacion.risc?.descripcio.toUpperCase() === 'ALT RISC',
                                                            'success verde' : evaluacion.risc?.descripcio.toUpperCase() === 'VULNERABILITAT',
                                                            'info azul' : evaluacion.risc?.descripcio.toUpperCase() === 'SENSE VALORACI&#211;' }">
                        {{evaluacion?.risc?.descripcio}}
                      </td>
                    </tr>
                    <!--/ Result Automatic Evaluations -->
                    <!--Result Professsional Evaluations -->
                    <tr>
                      <td class="text-right">{{ "OBS.risc-pro" | translate }}</td>
                      <td class="text-center">
                        <select class="form-control risc-pro"
                                id="t2person"
                                name="persona{{i}}"
                                #t2person="ngModel"
                                [ngModel]="evaluacion?.riscProfessional?.descripcio"
                                (change)="setRisc(evaluacion.riscProfessional, ambit , t2person.value)"
                                [ngClass]="{'warning amarillo' : evaluacion?.riscProfessional?.descripcio?.toUpperCase() === 'RISC',
                                            'danger rojo ' : evaluacion?.riscProfessional?.descripcio?.toUpperCase() === 'ALT RISC',
                                            'success verde' : evaluacion?.riscProfessional?.descripcio?.toUpperCase() === 'VULNERABILITAT',
                                            'info azul' : evaluacion?.riscProfessional?.descripcio?.toUpperCase() === 'SENSE VALORACI&#211;' }">
                          <option *ngFor="let risc of getFilterRiscos(evaluacion)" [value]="risc.descripcio"> {{risc.descripcio}} </option>
                        </select>

                      </td>
                    </tr>
                    <tr *ngIf=" evaluacion?.riscProfessional?.descripcio && evaluacion?.riscProfessional?.descripcio !== 'Sense Valoració'">
                      <td class="text-right">Justificació risc professional</td>
                      <td class="text-center">
                        <textarea required="true" class="form-control" type="text" id="fileRiscProfesionalObservation" #fileRiscProfesionalObservation="ngModel" name="b{{i}}"
                                  [ngModel]="evaluacion?.justificacio"
                                  (change)="evaluacion.justificacio = fileRiscProfesionalObservation.value">

                        </textarea>

                      </td>
                    </tr>
                    <!--/ Result Professsional Evaluations -->
                    </tbody>
                  </ng-container>
                </table>
              </div>
              <div class="col-xl-6">
                <table class="table table-bordered">
                  <thead class="table-active">
                  <th class="bg-primary-exact">{{ "OBS.factor" | translate }}</th>
                  <th class="text-center bg-primary-exact">{{ "OBS.person" | translate }}</th>
                  <th class="text-center bg-primary-exact">{{ "OBS.type" | translate }}</th>
                  </thead>
                  <tbody>
                  <ng-container *ngIf="ambit.contextualitzacio?.length > 0" >
                    <tr *ngFor="let context of ambit.contextualitzacio">
                      <td [ngClass]="{'danger rojo ' : context.factor?.gravetat.descripcio.toUpperCase() === 'RISC',
                                      'success verde' : context.factor?.gravetat.descripcio.toUpperCase() === 'PROTECCI&#211;' }">{{ context.factor?.descripcio }}</td>
                      <td class="text-center"
                          [ngClass]="{'danger rojo ' : context.factor?.gravetat.descripcio.toUpperCase() === 'RISC',
                                      'success verde' : context.factor?.gravetat.descripcio.toUpperCase() === 'PROTECCI&#211;' }" *ngIf="context.persona">
                        {{ context.persona?.tipusPersona?.descripcio }}
                      </td>
                      <td class="text-center"
                          [ngClass]="{'danger rojo ' : context.factor?.gravetat.descripcio.toUpperCase() === 'RISC',
                                      'success verde' : context.factor?.gravetat.descripcio.toUpperCase() === 'PROTECCI&#211;' }" *ngIf="!context.persona">
                        Unitat de Convivencia
                      </td>
                      <td class="text-center"
                          [ngClass]="{'danger rojo ' : context.factor?.gravetat.descripcio.toUpperCase() === 'RISC',
                                      'success verde' : context.factor?.gravetat.descripcio.toUpperCase() === 'PROTECCI&#211;' }">
                        {{ context.factor?.gravetat.descripcio }}</td>
                    </tr>
                  </ng-container>
                  <ng-container *ngIf="ambit.contextualitzacio?.length == 0">
                    <!-- No hay Factor de contextualización -->
                    <tr class="text-center">
                      <td colspan="3">{{ "OBS.no-factor" | translate }}</td>
                    </tr>
                    <!--/ No hay Factor de contextualización -->
                  </ng-container>
                  </tbody>
                </table>
              </div>
            </div>
            <!-- Observations Ambits -->
            <div class="form-group row">
              <div class="col-xl-12 px-3">
                <label for="fileObservationAutonomy" class="col-xl-form-label">
                  <i class="fa fa-pencil-square-o"></i> {{ "FORM.fileObs" | translate }}
                </label>
                <textarea [ngModel]="ambit?.observacions" class="form-control" type="text" name="ob{{i}}"
                          (change)="ambit.observacions = fileObservationAutonomy.value" id="fileObservationAutonomy" #fileObservationAutonomy="ngModel" ></textarea>
              </div>
            </div>
            <!--/ Observations Ambits -->
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Global -->
  <div class="row m-3" *ngFor="let global of value.ambit;let i = index">
    <ng-container *ngIf="global.ambit?.descripcio.toUpperCase() === 'GLOBALITAT DEL CAS'">
      <div class="col-xl-12">
        <div class="card">
          <div class="card-header text-white font-weight-bold rojo_4">
            {{ global.ambit?.descripcio.toUpperCase() }}
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-xl-6">
                <table class="table table-bordered">
                  <thead class="table-active">
                  <th class="bg-primary-exact">{{ "OBS.factor" | translate }}</th>
                  <th class="text-center bg-primary-exact">{{ "OBS.person" | translate }}</th>
                  </thead>
                  <tbody>
                  <ng-container *ngIf="global.contextualitzacio?.length > 0" >
                    <tr *ngFor="let context of global.contextualitzacio">
                      <td [ngClass]="{'danger rojo' : context.factor?.gravetat.descripcio.toUpperCase() === 'RISC',
                                      'success verde' : context.factor?.gravetat.descripcio.toUpperCase() === 'PROTECCI&#211;' }">{{ context.factor?.descripcio }}</td>
                      <td class="text-center"
                          [ngClass]="{'danger rojo' : context.factor?.gravetat.descripcio.toUpperCase() === 'RISC',
                                      'success verde' : context.factor?.gravetat.descripcio.toUpperCase() === 'PROTECCI&#211;' }">
                        {{ context.factor?.gravetat.descripcio }}</td>
                    </tr>
                  </ng-container>
                  <ng-container *ngIf="global.contextualitzacio?.length == 0">
                    <!-- No hay Factor de contextualización -->
                    <tr class="text-center">
                      <td colspan="3">{{ "OBS.no-factor" | translate }}</td>
                    </tr>
                  </ng-container>
                  </tbody>
                </table>
              </div>
              <div class="col-xl-6 px-3">
                <label for="fileObservationAutonomy" class="col-xl-form-label">
                  <i class="fa fa-pencil-square-o"></i> {{ "FORM.fileObs" | translate }}
                </label>
                <textarea class="form-control" type="text" value="{{ global.observacions }}" name="observationsss{{i}}"
                          [ngModel]="global?.observacions"
                            (change)="global.observacions = fileObservationGlobal.value" id="fileObservationGlobal" #fileObservationGlobal="ngModel"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
  <!-- Global -->

  <!-- Return to Back -->
  <div class="row my-3">
    <div class="col-xl-12 mb-3 text-center">
      <button  class="align-middle btn btn-outline-primary no-print btn-lg" type="submit" style="width: 20%;" > {{ "FORM.validation" | translate }}</button>
    </div>
  </div>
    <ng-template #validation let-modal>
      <div class="modal-header">
        <h4 class="modal-title">
          <span class="text-primary">
            Confirmar Validacio
          </span>
        </h4>
        <button type="button"
                class="close bg-primary text-white"
                aria-label="Close"
                (click)="modal.dismiss('Cross click')">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <p class="mt-3">Vols validar aquest diagnostic?</p>
      </div>
      <div class="modal-footer">
        <button type="submit"
                class="btn btn-outline-primary btn-large"
                (click)="modal.dismiss('Cross click'); finishDiagnostic()">
          {{ "TABLE.yes" | translate }}
        </button>
        <button type="button"
                class="btn btn-primary btn-large"
                aria-label="Close"
                (click)="modal.dismiss('Cross click')">
          {{ "TABLE.no" | translate }}
        </button>
      </div>
    </ng-template>
  </form>
  <!--/ Return to Back -->
</section>
